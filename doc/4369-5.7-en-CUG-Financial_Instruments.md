# Financial Instruments

**Customization Upgrade Guide**
Release 5.7

Area: Market Data

---
**Latest version of this document**

The latest version of this document can be found at https://docs.avaloq.com

**Feedback**

Please send any feedback to documentation@avaloq.com

Copyright Avaloq Group Ltd. All rights reserved. [cite: 5]
The information in this document is provided for informational purposes only, is subject to change without notice and is not warranted to be error-free. [cite: 4] No part of this document may be used, reproduced or transmitted in any form or by any means unless authorized by Avaloq Group Ltd through a written licence agreement. [cite: 5] Further, this document does not grant any rights to, or in, the products mentioned therein and no rights of any kind relating to such products will be granted except pursuant to written agreements with Avaloq Group Ltd. [cite: 6]
Avaloq Group Ltd. Allmendstr. 140 CH-8027 Zürich Switzerland [cite: 7]

---
## Version history

| Version / Date          | Section                                       | Description of the change                                                                                                                               |
| ----------------------- | --------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 5.7v2/29 April 2024     |                                               | Added a note to the Replacement of EVAL_SCEN_CSS by EVAL_CSS section, that two base parameters need to be set to false in 5.7 and above. [cite: 9]           |
|                         |                                               | Moved information from the introduction to each specific section to make the information more clear. [cite: 9]                                          |
| 5.7v1/11 December 2023  |                                               | Updated to add description that cf_mdl_id and opt_mdl_id are now mapped by default, and added a note about the de-released classification 528. [cite: 9] |
| 5.7v0/21 March 2023     |                                               | This is a new document for Release 5.7. [cite: 9]                                                                                                         |

---
## Contents

* 1 Introduction [cite: 12]
    * 1.1 Replacement of EVAL_SCEN_CSS by EVAL_CSS [cite: 12]
    * 1.2 Use of MEM_ASSET instead of MEM_DOC_ASSET [cite: 12]

---
## 1 Introduction

This topic is for customization specialists. It describes changes that you may need to make to your existing customization before you upgrade to Avaloq Core release 5.7. [cite: 14]

### 1.1 Replacement of EVAL_SCEN_CSS by EVAL_CSS

You can opt to update your customization for this change before upgrading to Avaloq Core release 5.7: [cite: 15]

* In releases 5.2 to 5.6, the Asset Evaluation Engine supports both the new and the old customization. [cite: 15] By default it continues to use the old customization, but you can set the `avq.ae` base parameter's `use_legacy_param` item to `false` to enable the new customization described in this section. [cite: 16, 17]
* Starting with release 5.7, the new customization will automatically be used. [cite: 18]
* For releases 5.7 and above, both parameters need to be set to `false`. This is mandatory for all clients. [cite: 19]

The following changes in customization are included in the Avaloq Asset Evaluation Engine in release 5.7: [cite: 20]

* The source EVAL_SCEN_CSS is removed and replaced by the EVAL_CSS source. [cite: 20]
* The task Calculate evaluation scenarios (id: 1847; task_eval_scen) no longer exists. [cite: 21] It was originally used to improve performance, but is no longer needed. There is no replacement. [cite: 22]
* The checkbox `use pre-calculated values` on task Evaluation of financial products program (id: 1848; task_eval) is removed because task Calculate evaluation scenarios no longer exists. [cite: 23]
* The following eval css functions need to be overwritten in customization, as the return values of 'null' in kernel are no longer mapped automatically to the kernel models: [cite: 24]
    * `cf_mdl_id`: must return `code_eval_mdl.dcf`. [cite: 24] At the moment there is no other model available. [cite: 25]
    * `opt_mdl_id`: must return the appropriate option pricing models, depending on the asset class, for example `code_eval_mdl.bs` for equity, commodity and FX options. [cite: 25]

In the past, the Asset Evaluation Engine had a lot of performance and memory problems associated with the use of the MEM_DOC_ASSET data dictionary by the EVAL_SCEN_CSS source. [cite: 26] The problems were caused by the fact that the asset order was loaded into memory. [cite: 27] To solve these problems, in Avaloq Core release 5.7 we: [cite: 28]

* Changed the data dictionary used by the Asset Evaluation Engine's customization from MEM_DOC_ASSET to a new data dictionary, MEM_ASSET [cite: 28]
* Replaced the CSS source used by the Asset Evaluation Engine from EVAL_SCEN_CSS to a new source, EVAL_CSS [cite: 28]

The new MEM_ASSET data dictionary is faster because asset orders are no longer loaded into memory. [cite: 29] It is accessed by the new customization source EVAL_CSS. [cite: 29]

For all functions of the new EVAL_CSS: [cite: 29]

* The `i_doc_asset` parameter from the MEM_DOC_ASSET data dictionary is replaced by `i_asset` from the new MEM_ASSET data dictionary [cite: 31]
* The `i_eval_date` parameter from the MEM_DOC_ASSET data dictionary is not present in the new MEM_ASSET data dictionary [cite: 31]

The following EVAL_SCEN_CSS functions are removed completely:

| Function removed   | Explanation                                                                 |
| ------------------ | --------------------------------------------------------------------------- |
| `cf_hor_in_years`  | Perpetuals need to have a call or put date otherwise no evaluation is possible |
| `use_par_flo`      | The new Avaloq kernel code now behaves as if use_par_flo is set to false    |
| `notnl_date_expr`  | Depended on `use_par_flo`                                                    |

The following functions are renamed: [cite: 33]

| Old function name in EVAL_SCEN_CSS | New function name in EVAL_CSS |
| ------------------------------------ | ----------------------------- |
| `pb_rfig_intr_calc_method_id`      | `intr_calc_method_id`         |
| `pb_rfig_compd_mtd_id`             | `compd_mtd_id`                |
| `pb_rfig_src_price_type_id`        | `src_price_type_id`           |
| `vlt_struct_collect_id`            | `vsc_id`                      |

The following functions have new default behaviour: [cite: 35]

| Function name           | New default setting in EVAL_CSS |
| ----------------------- | ------------------------------- |
| `opt_mdl_id`            | Null                            |
| `alw_vlt_fallbk`        | False                           |
| `intr_calc_method_id`   | Null                            |
| `compd_mtd_id`          | Null                            |
| `src_price_type_id`     | Null                            |

### 1.2 Use of MEM_ASSET instead of MEM_DOC_ASSET

**Note regarding de-release of classification 528 (previously announced in Financial Instruments Customization Upgrade Guide (Doc. ID: 4369), release 4.9):** [cite: 37]

If you are relying on classification 528 for downstream consumers, one solution would be to create your own derived classifications and classes to mimic the prior 528 classification. [cite: 37]
In Avaloq Core 5.7, the Asset Evaluation Engine customization no longer uses the MEM_DOC_ASSET data dictionary. [cite: 38] Instead it uses the new MEM_ASSET data dictionary. [cite: 39]

The following fields are no longer available; they are completely removed: [cite: 39]

| Field removed         | Description                                                                                                 |
| --------------------- | ----------------------------------------------------------------------------------------------------------- |
| `block_id`            | It's redundant because the new Asset Evaluation Engine already discards template assets. [cite: 42]                   |
| `dflt_trade_curry_id` | Checking for exotic currencies can now be done with a derived class. [cite: 42]                                   |
| `outstand_pieces`     | Checking for jumbo bonds can now be done with a derived class. [cite: 42]                                         |
| `sort_alpha`          | This was derived from four keys: iso, tks, isin and sor_nr. The aim was to classify certain assets. This can now also be done using classes. [cite: 42] |
| `eff_date`            | The eff_date from the order DDIC is not available in the new MEM_ASSET data dictionary. The replacement has to be found on a case-by-case basis. [cite: 42] |

**Keys** [cite: 43]

Keys are no longer available the customization should not be asset or key specific. [cite: 43] If you still have such a use case, you should mark it with a specific class. [cite: 44]

**Additions** [cite: 45]

Additions are no longer available. They will have to be replaced with a corresponding class. [cite: 45]

**Classes**

All kernel classes are supported. [cite: 46] However the syntax used to access classes has changed: [cite: 46]

* Old pattern: `mem_doc_asset.obj_extn.classif_id` [cite: 46]
* New pattern: `mem_asset.class(classif_id)` [cite: 46]

Here's a code example using the old pattern: [cite: 46]

```sql
function opt_mdl_id (
    i_doc_asset mem_doc_asset,
    i_calc_md_scen_id id_table_code_md_scen,
    i_eval_date date
) return id_table_code_eval_mdl
is
begin
    if i_doc_asset.obj_extn.ass_type_id in (btt.asset.obj_extn.ass_type.class.cfc) then
        return code_eval_mdl.bn;
    else
        return null;
    end if;
exception
    when others then
        err.raise_fa('eval_scen_css.opt_mdl_id('||i_doc_asset||', '||i_calc_md_scen_id||', '||i_eval_date||')');
end opt_mdl_id;

nd here's a code example using the new pattern:    

SQL

function opt_mdl_id(
    i_asset mem_asset,
    i_calc_md_scen_id id_table_code_md_scen
) return id_table_code_eval_mdl
is
begin
    if i_asset.class(btt.asset.obj_extn.ass_type_id) in (btt.asset.obj_extn.ass_type.class.cfc) then
        return code_eval_mdl.bn;
    else
        return null;
    end if;
exception
    when others then
        err.raise_fa('eval_css.opt_mdl_id('||i_asset||', '||i_calc_md_scen_id||')');
end opt_mdl_id;